<?php
namespace thinkerg\HermesMailing\console;

use Yii;
use yii\console\Controller;
use yii\helpers\Console;
use yii\base\Exception;

/**
 *
 * @author tlsadmin
 *
 * @property $module \thinkerg\HermesMailing\Module
 */
class DefaultController extends Controller
{

    /**
     * Status value of NEVER SENT.
     */
    const ST_NEVER = null;

    /**
     * Status value of FAILED. FAILED email will never be resent again.
     */
    const ST_FAILED = 'failed';

    /**
     * Status value of RETRY. RETRY email will be tried to resend until reach the EmailQueue::$retry_time.
     */
    const ST_RETRY = 'retry';

    /**
     * Status value of SUCCEED.
     */
    const ST_SUCCEED = 'succeed';

    /**
     * Whether to enable test mode. If set to ture, command will call testSend() method of the mailer adaptor.
     * Default to false.
     * @var bool
     */
    public $testMode = false;

    /**
     * Email AR model name.
     * Make sure the model class is imported after installation.
     * LEAVE THIS NULL, unless the model name is not generated by the table name.
     * If this is set, table name will be retrieved by "tableName()" of its instance.
     * This is for using some already existed AR. Won't be needed for default installation.
     * @var string
     */
    public $modelClass = 'app\models\EmailQueue';

    /**
     * Column (attribute name) of email table to store process signature.
     * This is mandatory attribute to the AR model. There must be a column to play this role.
     * Default to "signature".
     * @var string
     */
    public $signatureCol = 'signature'; // mandatory  column

    /**
     * Column (attribute name) of email table to store sending status.
     * This is mandatory attribute to the AR model. There must be a column to play this role.
     * Default to "status".
     * @var string
     */
    public $statusCol = 'status'; // mandatory  column

    /**
     * Column (attribute name) of email table to store retry times.
     * Optional attribute, will only take effects when it exists in the model.
     * Default to "retry_times".
     * @var string
     */
    public $retryCol = 'retry_times';

    /**
     * Column (attribute name) of email table to assign emails to be send by the processes from specific server.
     * Optional attribute, will only take effects when it exists in the model.
     * Default to "send_by".
     * @var string
     */
    public $sendByCol = 'send_by';

    /**
     * Column (attribute name) of email table to store the server id that actually sent this email out.
     * Optional attribute, will only take effects when it exists in the model.
     * Default to "sent_by".
     * @var string
     */
    public $sentByCol = 'sent_by';

    /**
     * Server id of processes start on CURRENT SERVER. The process will retrieve emails assigned to THIS server id in central database.
     * When this is distributed on different servers, make sure this is unique among all servers which is connecting to the same central db.
     * Default to 0.
     * @var int
     */
    public $serverId = 0;

    /**
     * How many emails to sign each time.
     * Default to 10.
     * @var int
     */
    public $signSize = 50;

    /**
     * How many signed emails are loaded to memory each time.
     * Default to 10.
     * @var int
     */
    public $pageSize = 10;

    /**
     * How many times to resend after first send is failed.
     * Only take effects when column specified by EmailQueueCommand::$retryCol exists.
     * Default to 0.
     * @var int
     */
    public $retryTimes = 0;

    /**
     * Instance of CDbConnection used.
     * Left it to null to use the db connection of main console application.
     * Use array to initialize a new CDbConnection object.
     * Or use a exsiting CDbConnection instance directly.
     * @var null|array|\yii\db\Connection
     */
    public $db;

    /**
     * Spam rules for current PROCESS, each element in format m=>n, where m is the SENT_COUNT n is the SECOND.
     * This means pause n seconds after every m mails sent out.
     * When a larger "m" value is times of smaller "m", only the largest "m" rule is applied, all smaller "m" rules are ignored.
     * @example array(
     *     500 => 10,
     *     1000 => 30
     * ); // Pause 10 secs after 500 emails sent out, pause 30 secs every 1000 emails sent out.
     * @var array
     */
    public $spamRules;

    /**
     * Mailer adaptor definition that used to really send email.
     * 'class' element is the alias of adaptor class, all rests are attributes of the adaptor.
     * The specified class must implement interface IMailerAdaptor and the send/testSend methods must return boolean.
     * Default to array('class' => 'EmailQueue.adaptors.ExampleMailerAdaptor').
     * @var array
     */
    public $mailerAdaptor = 'EmailQueue.adaptors.ExampleMailerAdaptor';

    /**
     * Instance of mailer adaptor specified by EmailQueue::$mailerAdaptor.
     * @var IMailerAdaptor
     */
    private $_mailerAdaptor;

    /**
     * Emailing counter of current process.
     * @var int
     */
    private $_sendingCount = 0;

    /**
     * Used internally while installing.
     * @var bool
     */
    private $_readyToInstall;

    /**
     * Signature of current process.
     * @var string
     */
    private $_signature;

    /**
     * Static model of mail AR.
     * Returned by invoking MODEL_NAME::model();
     * Default to object of QueuedEmail.
     * @var CActiveRecord
     */
    private $_templateModel;

    /**
     * Used by method EmailQueue::applySpamRules2();
     * DON'T modify it.
     * @var array
     */
    private $_nextStop;

    /* =============== Command options ============================ */
    public $signUnassigned = true;

    public $renewSignature = false;

    /* =============== End of command options ===================== */

    /*
     * ============================================================
     *
     * Attributes below are for installion, and might be used at most for once.
     * If you are using your own Email AR Model, please do not touch this part.
     *
     * ============================================================
     */
    public $enableInstaller = false;

    public $migration = 'thinkerg\HermesMailing\installer\Migration';

    public $giiID = 'gii';

    public $actions = [];

    public $fillTestDataAction = 'thinkerg\HermesMailing\installer\actions\FillTestAction';

    protected $installAction = 'thinkerg\HermesMailing\installer\actions\InstallAction';

    protected $uninstallAction = 'thinkerg\HermesMailing\installer\actions\UninstallAction';

    private $_migration;


    /* (non-PHPdoc)
     * @see \yii\base\Controller::actions()
     */
    public function actions()
    {
        if ($this->enableInstaller) {
            $this->actions = array_merge([
                'install' => $this->installAction,
                'uninstall' => $this->uninstallAction,
                'fill-test-data' => $this->fillTestDataAction,
            ], $this->actions);
        }
        return $this->actions;
    }

    public function actionIndex()
    {
        $this->run("/help", [$this->id]);
        return 0;
    }

    public function actionSendQueue()
    {
        while ($signedNum = $this->signEmails($this->signUnassigned, $this->renewSignature)) {
            var_dump("Signed $signedNum entries with signature $this->_signature.");
        }
    }

    /**
     * Sign emails to claim emails send by CURRENT PROCESS, then signed emails will not be retrieved by other processes.
     *
     * @param bool $signUnassigned Whether to sign email those are not assigned to any server_id (IS NULL).
     * Take effects only when column specified by EmailQueueCommand::$sendByCol exists.
     * @param bool $renewSignature Whether to renew the signature when sign emails every time.
     *
     * @todo Implement this
     */
    protected function signEmails($signUnassigned = true, $renewSignature = false)
    {
        $modelClass = $this->_templateModel;
        $where = [$this->signatureCol => null];
        if ($modelClass->hasAttribute($this->sendByCol)) {
            $where = ['and', $where];
            if ($signUnassigned) {
                $where[] = ['or', [$this->sendByCol => $this->serverId], [$this->sendByCol => null]];
            } else {
                $where[] = [$this->sendByCol => $this->serverId];
            }
        }
        $cols = [$this->signatureCol => $this->getSignature($renewSignature)];
        $queryBuilder = $this->db->getQueryBuilder();
        $sql = $queryBuilder->update($modelClass::tableName(), $cols, $where, $params);
        if ($this->signSize) {
            $sql = $queryBuilder->buildOrderByAndLimit($sql, null, $this->signSize, null);
        }

        return $this->db->createCommand($sql, $params)->execute();
    }

    /**
     * Signature getter.
     * Sleep 1 micro second when renew to ensure the sigature is always unique.
     * @param bool $renew
     * @return string
     */
    public function getSignature($renew = false)
    {
        if ($renew || is_null($this->_signature)) {
            usleep(1);
            $this->_signature = md5(microtime(true) . $this->serverId);
        }
        return $this->_signature;
    }

    /**
     *
     * @return \thinkerg\HermesMailing\components\Migration
     */
    public function getMigration()
    {
        if (empty($this->_migration)) {
            $this->_migration = Yii::createObject($this->migration);
        }
        return $this->_migration;
    }


    /**
     * Terminate application when user cancels operations or some error happens.
     */
    public function userCancel()
    {
        $this->stdout("User canceled.\n", Console::FG_YELLOW);
        Yii::$app->end();
    }



    /* (non-PHPdoc)
     * @see \yii\base\Object::init()
     */
    public function init()
    {
        parent::init();

        // Initialize db connection, this step is for using emailing system in a separated database.
        if (is_null($this->db)) {
            $this->db = Yii::$app->getDb();
        } elseif ($this->db instanceof \yii\db\Connection) {
            // Db initialized, do nothing.
        } else {
            $this->db = Yii::createObject($this->db);
        }

        //Initialize template model of the mail AR.
        try {
            $this->_templateModel = Yii::createObject($this->modelClass);
        } catch (\ReflectionException $refE) {
            $err = "Cannot find model class <{$this->modelClass}>." . PHP_EOL;
            $err .= "Maybe you need to install the module and setup the property \"modelClass\"." . PHP_EOL;
            $this->stderr($err, Console::FG_RED);
            Yii::$app->end(1);
        } catch (Exception $e) {
            throw $e;
        }


    }

    /* (non-PHPdoc)
     * @see \yii\console\Controller::options()
     */
    public function options($actionID)
    {
        empty($actionID) && ($actionID = $this->defaultAction);
        $actionOptions = [
            'send-queue' => ['signUnassigned', 'renewSignature']
        ];

        if (isset($actionOptions[$actionID])) {
            return array_merge(parent::options($actionID), $actionOptions[$actionID]);
        } else {
            return parent::options($actionID);
        }

    }


}

?>
